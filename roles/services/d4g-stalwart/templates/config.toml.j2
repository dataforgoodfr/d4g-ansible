# Stalwart configuration, see https://stalw.art/docs/configuration/overview
# currently does not rely on jinja templating directly but loads env variables


# The following configuration are kept in this TOML as single source of truth
# cf https://stalw.art/docs/configuration/overview#local-and-database-settings

[config]
local-keys = [ "store.*", "directory.*", "tracer.*", "!server.blocked-ip.*", "!server.allowed-ip.*", "server.*",
    "authentication.fallback-admin.*", "cluster.*",   "config.local-keys.*",
    "storage.data", "storage.blob", "storage.lookup", "storage.fts", "storage.directory", "certificate.*",
    "authentication.master.*", "http.*" ]


#####################
### Server config ###
#####################

[server]
hostname = "%{env:STALWART_SERVER_HOSTNAME}%"
max-connections = 10000

[server.socket]
backlog = 1024
nodelay = true
reuse-addr = true
reuse-port = true


### Listeners ###

[server.listener.http]
bind = "[::]:8080"
protocol = "http"

[server.listener.https]
bind = "[::]:443"
protocol = "http"

[server.listener.https.tls]
implicit = true

[server.listener.imap]
bind = "[::]:143"
protocol = "imap"

[server.listener.imaptls]
bind = "[::]:993"
protocol = "imap"

[server.listener.imaptls.tls]
implicit = true

[server.listener.pop3]
bind = "[::]:110"
protocol = "pop3"

[server.listener.pop3s]
bind = "[::]:995"
protocol = "pop3"

[server.listener.pop3s.tls]
implicit = true

[server.listener.sieve]
bind = "[::]:4190"
protocol = "managesieve"

[server.listener.smtp]
bind = "[::]:25"
protocol = "smtp"

[server.listener.submission]
bind = "[::]:587"
protocol = "smtp"

[server.listener.submissions]
bind = "[::]:465"
protocol = "smtp"

[server.listener.submissions.tls]
implicit = true


#############################
### Network configuration ###
#############################

# cf https://stalw.art/docs/http/settings

[http]
url = "'https://' + config_get('server.hostname')"
use-x-forwarded = true

[http.rate-limit]
account = "1000/1m"
anonymous = "100/1m"

#############################
### Storage configuration ###
#############################

[storage]
data = "postgres"
blob = "s3"
fts = "postgres"
lookup = "postgres"
directory = "internal"


### IAM directory ###

[directory.internal]
type = "internal"
store = "postgres"


### Postgres ###

[store.postgres]
type = "postgresql"
host = "%{env:POSTGRES_HOST}%"
port = "%{env:POSTGRES_PORT}%"
database = "%{env:POSTGRES_DB}%"
user = "%{env:POSTGRES_USER}%"
password = "%{env:POSTGRES_PASSWORD}%"
compression = "lz4"
timeout = "30s"

[store.postgres.pool]
max-connections = 50

[store.postgres.purge]
frequency = "0 2 *"  # every day at 2AM

[store.postgres.tls]
allow-invalid-certs = false
enable = false


### S3 ###

[store.s3]
type = "s3"
endpoint = "%{env:S3_ENDPOINT}%"
region = "%{env:S3_REGION}%"
bucket = "%{env:S3_BUCKET}%"
access-key = "%{env:S3_ACCESS_KEY}%"
secret-key = "%{env:S3_SECRET_KEY}%"
key-prefix = "%{env:S3_KEY_PREFIX}%"
compression = "lz4"
max-retries = 5
timeout = "30s"

[store.s3.purge]
frequency = "0 3 *"  # every day at 3AM


######################
### Logging config ###
######################

[tracer.stdout]
type = "stdout"
level = "%{env:CONSOLE_LOG_LEVEL}%"
enable = true
ansi = false


#########################
### Global admin users ###
#########################

# cf https://stalw.art/docs/auth/authorization/administrator/

[authentication.fallback-admin]
user = "d4gadmin"
secret = "%{env:FALLBACK_ADMIN_PASSWORD}%"

[authentication.master]
user = "master"
secret = "%{env:MASTER_PASSWORD}%"
